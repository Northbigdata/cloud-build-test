# .gitlab-ci.yml

stages:
  - build
  - deploy

variables:
  GCP_PROJECT_ID: samsung-mx-test 
  GCP_REGION: asia-northeast3
  ARTIFACT_REGISTRY: my-repo
  SERVICE_NAME: hello-spring-boot
  IMAGE_TAG: $CI_COMMIT_SHA

build_and_deploy:
  stage: deploy
  tags:
    - test
  image: google/cloud-sdk:latest
  services:
    - docker:dind
  script:
    # 1. Use a here-document to create a valid JSON key file
    - |-
      cat > /tmp/gcp_key.json << EOF
      $GCP_SA_KEY
      EOF
    
    # 2. Authenticate using the temporary file
    - gcloud auth activate-service-account --key-file=/tmp/gcp_key.json
    
    # 3. Configure Docker for authentication
    - gcloud auth configure-docker $GCP_REGION-docker.pkg.dev
    
    # 4. Build and push the Docker image
    - docker build -t $GCP_REGION-docker.pkg.dev/$GCP_PROJECT_ID/$ARTIFACT_REGISTRY/$SERVICE_NAME:$IMAGE_TAG .
    - docker push $GCP_REGION-docker.pkg.dev/$GCP_PROJECT_ID/$ARTIFACT_REGISTRY/$SERVICE_NAME:$IMAGE_TAG
    
    # 5. Deploy to Cloud Run
    - gcloud run deploy $SERVICE_NAME --image $GCP_REGION-docker.pkg.dev/$GCP_PROJECT_ID/$ARTIFACT_REGISTRY/$SERVICE_NAME:$IMAGE_TAG --platform managed --region $GCP_REGION --allow-unauthenticated