# .gitlab-ci.yml

stages:
  - build
  - deploy

variables:
  GCP_PROJECT_ID: samsung-mx-test 
  GCP_REGION: asia-northeast3
  ARTIFACT_REGISTRY: my-repo
  SERVICE_NAME: hello-spring-boot
  IMAGE_TAG: $CI_COMMIT_SHA

build_and_deploy:
  stage: deploy
  tags:
    - test
  image: google/cloud-sdk:latest
  services:
    - docker:dind
  script:
    # 1. GitLab이 생성한 키 파일을 cat으로 읽어 gcloud에 전달
    - cat $GCP_SA_KEY | gcloud auth activate-service-account --key-file=-
    
    # 2. Docker가 Artifact Registry에 인증할 수 있도록 설정
    - gcloud auth configure-docker $GCP_REGION-docker.pkg.dev
    
    # 3. Docker 이미지 빌드 및 푸시
    - docker build -t $GCP_REGION-docker.pkg.dev/$GCP_PROJECT_ID/$ARTIFACT_REGISTRY/$SERVICE_NAME:$IMAGE_TAG .
    - docker push $GCP_REGION-docker.pkg.dev/$GCP_PROJECT_ID/$ARTIFACT_REGISTRY/$SERVICE_NAME:$IMAGE_TAG
    
    # 4. Cloud Run에 배포
    - gcloud run deploy $SERVICE_NAME --image $GCP_REGION-docker.pkg.dev/$GCP_PROJECT_ID/$ARTIFACT_REGISTRY/$SERVICE_NAME:$IMAGE_TAG --platform managed --region $GCP_REGION --allow-unauthenticated